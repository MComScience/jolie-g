function drawLine(e,t,i){canvas.beginPath(),canvas.moveTo(e.x,e.y),canvas.lineTo(t.x,t.y),canvas.lineWidth=4,canvas.strokeStyle=i,canvas.stroke()}function tick(){if(loadingMessage.innerText="⌛ Loading video...",video.readyState===video.HAVE_ENOUGH_DATA){loadingMessage.hidden=!0,canvasElement.hidden=!1,outputContainer.hidden=!1,canvasElement.height=video.videoHeight,canvasElement.width=video.videoWidth,canvas.drawImage(video,0,0,canvasElement.width,canvasElement.height);var e=canvas.getImageData(0,0,canvasElement.width,canvasElement.height),t=jsQR(e.data,e.width,e.height,{inversionAttempts:"dontInvert"});if(t&&t.data){++countResults,lastResult=t,drawLine(t.location.topLeftCorner,t.location.topRightCorner,"#FF3B58"),drawLine(t.location.topRightCorner,t.location.bottomRightCorner,"#FF3B58"),drawLine(t.location.bottomRightCorner,t.location.bottomLeftCorner,"#FF3B58"),drawLine(t.location.bottomLeftCorner,t.location.topLeftCorner,"#FF3B58"),outputMessage.hidden=!0,outputData.parentElement.hidden=!1,outputData.innerText=t.data,video.pause();const e=yii.getQueryParams(t.data);$("#card-camera").hide(),app.saveQrcode(e.code)}else outputMessage.hidden=!1,outputData.parentElement.hidden=!0}lastResult||requestAnimationFrame(tick)}async function initializeApp(){liff.isLoggedIn()||liff.isInClient()?(await app.getProfile(),$("body").waitMe("hide")):window.alert('To get an access token, you need to be logged in. Tap the "login" button below and try again.')}window.onload=function(e){liff.init({liffId:"1552736042-KqeVvaMw",withLoginOnExternalBrowser:!0}).then(()=>{liff.isLoggedIn()?initializeApp():liff.login()}).catch(e=>{alert(JSON.stringify(e))})};var video=document.createElement("video"),canvasElement=document.getElementById("canvas"),canvas=canvasElement.getContext("2d"),loadingMessage=document.getElementById("loadingMessage"),outputContainer=document.getElementById("output"),outputMessage=document.getElementById("outputMessage"),outputData=document.getElementById("outputData");navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(function(e){video.srcObject=e,video.setAttribute("playsinline",!0),video.play(),requestAnimationFrame(tick)});var lastResult,user,account,countResults=0;axios.interceptors.request.use(function(e){return e},function(e){return Promise.reject(e)}),axios.interceptors.response.use(e=>_.get(e,"data",e),e=>Promise.reject(_.get(e,"response.data",e)));var restaurants=[],app={initLoading:function(){$("body").waitMe({effect:"roundBounce",text:"",bg:"rgba(255,255,255,0.7)",color:"#000",maxSize:"",waitTime:-1,textPos:"vertical",fontSize:"",source:"",onClose:function(){}})},getProfile:async function(){try{const e=liff.getIDToken(),t=await liff.getProfile();let i=await axios.get(`/v1/user/me?id_token=${e}`);user=i.user,account=i.account,localStorage.setItem("profile",JSON.stringify(t)),t.pictureUrl&&$("#picture").attr("src",t.pictureUrl),i.account?($("#sex-name").html(i.profile.sex_name),$("#fullname").html(i.profile.first_name+" "+i.profile.last_name),$("#birthday").html(i.profile.birthday),$("#tel").html(i.profile.tel),$("#province").html(i.profile.province_name),await this.getQrList(),$("html, body").animate({scrollTop:$(document).height()},1e3)):window.location.replace("/site/register")}catch(e){$("body").waitMe("hide"),Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด!",text:e.message}),setTimeout(()=>{liff.logout(),window.location.reload()},1e3)}},scanQr:function(){lastResult=null,countResults=0,video.play(),$("#card-camera").show(),setTimeout(()=>{$("html, body").animate({scrollTop:parseInt($("#qr-total").offset().top)},1e3),requestAnimationFrame(tick)},1e3)},saveQrcode:async function(e){if(user)try{Swal.fire({title:"กรุณารอสักครู่!",text:"",timerProgressBar:!0,allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}}),await axios.post("/v1/user/save-qrcode",{user_id:user.id,code:e}),Swal.fire({icon:"success",title:"ระบบได้ทำการบันทึกรายการของคุณแล้ว",text:"",timer:3e3,timerProgressBar:!0,allowOutsideClick:!1,showConfirmButton:!1,willClose:()=>{$("html, body").animate({scrollTop:$(document).height()},1e3)}}),app.getQrList()}catch(e){Swal.fire({icon:"warning",title:"ไม่สามารถสแกนคิวอาร์โค้ดได้!",text:e.message})}},getQrList:async function(){if(user)try{const t=await axios.get(`/v1/user/qrcode-list?userId=${user.id}`);$("#qr-total").html(t.length),$("#qr-list-item").find(".col-sm-2").remove();for(let i=0;i<t.length;i++){const a=t[i];var e=`<div class="col-sm-2"><div class="qrcode"><i class="fa fa-qrcode"></i> ${a.qrcode_id}</div></div>`;$("#qr-list-item").append(e),restaurants.push(parseFloat(a.qrcode_id))}}catch(e){Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด!",text:e.message})}}};app.initLoading(),$(window).load(function(){$("html, body").animate({scrollTop:$(document).height()},1e3)});